<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Required meta tags -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>WeRent - Your Dream Home</title>
  <!-- Bootstrap 5.3 CSS CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B1xZhJ5xulwld6J7U6ZlD2+J5i9GqV" crossorigin="anonymous">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/sales.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <!-- Flatpickr Calendar CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }
    
    .loading {
      text-align: center;
      padding: 50px;
      font-size: 18px;
    }
    
    .error {
      text-align: center;
      padding: 50px;
      color: #dc3545;
      font-size: 18px;
    }
    
    .property-status {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      text-transform: uppercase;
    }
    
    .property-status.sold {
      background: #dc3545;
    }
    
    .property-status.booked {
      background: #ffc107;
      color: #000;
    }
    
    /* Fixed Properties Layout - Force 3 cards per row */
    .properties {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    #propertiesContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: flex-start;
    }
    
    /* Desktop: 3 cards per row */
    @media (min-width: 992px) {
      #propertiesContainer {
        justify-content: space-between;
      }
      .sales-card {
        width: calc(33.333% - 14px);
        flex: 0 0 calc(33.333% - 14px);
        max-width: calc(33.333% - 14px);
      }
    }
    
    /* Tablet: 2 cards per row */
    @media (min-width: 768px) and (max-width: 991px) {
      .sales-card {
        width: calc(50% - 10px);
        flex: 0 0 calc(50% - 10px);
        max-width: calc(50% - 10px);
      }
    }
    
    /* Mobile: 1 card per row */
    @media (max-width: 767px) {
      .properties {
        padding: 10px;
      }
      #propertiesContainer {
        gap: 15px;
        justify-content: center;
      }
      .sales-card {
        width: 100%;
        flex: 0 0 100%;
        max-width: 400px;
      }
    }
    
    .sales-card {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      background: white;
      flex-shrink: 0;
    }
    
    .sales-card img {
      width: 100%;
      height: 250px;
      object-fit: cover;
    }
    
    .content {
      padding: 20px;
    }
    
    .content h3 {
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .property-details {
      display: flex;
      gap: 15px;
      margin: 10px 0;
      font-size: 14px;
      color: #666;
    }
    
    .detail-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .book-btn, .details-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif !important;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .book-btn {
      background: #e67e22;
      color: white;
    }
    
    .book-btn:hover {
      background: #0056b3;
    }
    
    .details-btn {
      background: #f8f9fa;
      color: #333;
      border: 1px solid #ddd;
    }
    
    .details-btn:hover {
      background: #e9ecef;
    }
    
    .property-expanded {
      display: none;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .amenities-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .amenity-tag {
      background: #f8f9fa;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      color: #666;
    }
    
    #viewingModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      position: relative;
      font-family: 'Poppins', sans-serif;
    }
    
    .close {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
    }
    
    .modal-content form {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }
    
    .modal-content input,
    .modal-content textarea {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: 'Poppins', sans-serif;
    }
    
    .datetime-container {
      display: flex;
      gap: 10px;
    }
    
    .datetime-container input {
      flex: 1;
    }
    
    /* New Success Modal Styling */
    #viewingSuccess {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1001;
      font-family: 'Poppins', sans-serif;
      align-items: center;
      justify-content: center;
    }
    
    .success-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 5px 20px rgba(0,0,0,0.2);
      animation: fadeInUp 0.5s ease;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .success-icon {
      width: 70px;
      height: 70px;
      background: #28a745;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 35px;
    }
    
    .success-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #333;
    }
    
    .success-message {
      font-size: 16px;
      color: #666;
      margin-bottom: 25px;
      line-height: 1.5;
    }
    
    .success-button {
      background: #e67e22;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Poppins', sans-serif;
    }
    
    .success-button:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }

   

    .menu-toggle {
      display: none;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .nav-links {
        position: fixed;
        top: 70px;
        left: -100%;
        width: 100%;
        height: calc(100vh - 70px);
        background: white;
        flex-direction: column;
        justify-content: flex-start;
        padding-top: 2rem;
        transition: left 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 999;
      }

      .nav-links.active {
        left: 0;
      }

      .menu-toggle {
        display: block;
      }
    }

    .find-sales {
      text-align: center;
      padding: 2rem 0;
      background: #f8f9fa;
    }

    .find-sales h2 {
      font-size: 2.5rem;
      font-weight: 600;
      color: #f39c12;
      margin: 0;
    }
    
    /* Calendar styling - added from rentals.html */
    .calendar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 15px 0;
    }
    
    .calendar span {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .calendar .available {
      background-color: #e8f5e9;
      color: #2e7d32;
      border: 1px solid #a5d6a7;
    }
    
    .calendar .available:hover {
      background-color: #2e7d32;
      color: white;
      transform: scale(1.1);
    }
    
    .calendar .booked {
      background-color: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }
    
    .calendar .booked:hover {
      background-color: #c62828;
      color: white;
      transform: scale(1.1);
    }
    
    /* Calendar Modal */
    .calendar-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .calendar-modal-content {
      background: white;
      border-radius: 10px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 15px 40px rgba(0,0,0,0.2);
      position: relative;
    }
    
    .calendar-modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 24px;
      color: #666;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      line-height: 1;
    }
    
    .calendar-header {
      margin-bottom: 20px;
      text-align: center;
    }
    
    .calendar-header h3 {
      margin: 0;
      color: #333;
      font-weight: 600;
      font-size: 1.5rem;
    }
    
    .calendar-property-info {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .calendar-property-info img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 15px;
    }
    
    .calendar-property-details h4 {
      margin: 0 0 5px 0;
      font-size: 1.1rem;
      color: #333;
    }
    
    .calendar-property-details p {
      margin: 0;
      color: #666;
      font-size: 0.9rem;
    }
    
    .calendar-legend {
      display: flex;
      gap: 15px;
      margin: 15px 0;
      justify-content: center;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      font-size: 0.85rem;
      color: #666;
    }
    
    .legend-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
      margin-right: 5px;
    }
    
    .legend-available {
      background: #e8f5e9;
      border: 1px solid #a5d6a7;
    }
    
    .legend-booked {
      background: #ffebee;
      border: 1px solid #ef9a9a;
    }
    
    .legend-past {
      background: #e0e0e0;
      border: 1px solid #bdbdbd;
    }
    
    .calendar-actions {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    
    .calendar-book-btn {
      background: #e67e22;
      color: white;
      border: none;
      padding: 10px 25px;
      border-radius: 5px;
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .calendar-book-btn:hover {
      background: #d35400;
      transform: translateY(-2px);
    }
    
    /* Flatpickr Customization */
    .flatpickr-calendar {
      font-family: 'Poppins', sans-serif !important;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1) !important;
      border-radius: 10px !important;
      border: none !important;
      width: 100% !important;
    }
    
    .flatpickr-day {
      border-radius: 50% !important;
      transition: all 0.2s ease !important;
    }
    
    .flatpickr-day.flatpickr-disabled {
      background-color: #ffebee !important;
      color: #c62828 !important;
      text-decoration: line-through !important;
    }
    
    .flatpickr-day.prevMonthDay.flatpickr-disabled,
    .flatpickr-day.nextMonthDay.flatpickr-disabled {
      opacity: 0.5 !important;
    }
    
    .flatpickr-day.flatpickr-disabled:hover {
      background-color: #ffebee !important;
    }
    
    .flatpickr-day.past-date {
      background-color: #e0e0e0 !important;
      color: #9e9e9e !important;
      text-decoration: line-through !important;
      cursor: not-allowed !important;
      pointer-events: none !important;
    }
    
    .flatpickr-day.booked-date {
      background-color: #ffebee !important;
      color: #c62828 !important;
      border-color: #ef9a9a !important;
      cursor: not-allowed !important;
      pointer-events: none !important;
    }
    
    .flatpickr-day.flatpickr-disabled.startRange,
    .flatpickr-day.flatpickr-disabled.endRange {
      background-color: #ffcdd2 !important;
      color: #c62828 !important;
      border-color: #ef5350 !important;
    }
    
    .flatpickr-day.selected {
      background: #e67e22 !important;
      border-color: #e67e22 !important;
    }
    
    .flatpickr-day:hover {
      background: #f5f5f5 !important;
    }
    
    .flatpickr-months {
      padding-top: 10px !important;
    }
    
    .flatpickr-month {
      height: 50px !important;
    }
    
    .flatpickr-current-month {
      padding-top: 10px !important;
      font-size: 1.1rem !important;
    }
    
    .flatpickr-weekday {
      font-weight: 600 !important;
      color: #666 !important;
    }
    
    /* Month Navigation Buttons - more visible */
    .flatpickr-months .flatpickr-prev-month,
    .flatpickr-months .flatpickr-next-month {
      height: 40px !important;
      padding: 10px !important;
      background-color: rgba(230, 126, 34, 0.1) !important;
      border-radius: 50% !important;
      transition: all 0.3s ease !important;
    }
    
    .flatpickr-months .flatpickr-prev-month:hover,
    .flatpickr-months .flatpickr-next-month:hover {
      background-color: rgba(230, 126, 34, 0.2) !important;
    }
    
    .flatpickr-months .flatpickr-prev-month svg,
    .flatpickr-months .flatpickr-next-month svg {
      fill: #e67e22 !important;
    }
    
    /* GALLERY STYLES ADDED FROM RENTALS.HTML */
    .property-image-container {
      position: relative;
      width: 100%;
      height: 250px;
      overflow: hidden;
    }
    
    .property-image-slider {
      display: flex;
      width: 100%;
      height: 100%;
      transition: transform 0.3s ease;
    }
    
    .property-image-slide {
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
    }
    
    .slider-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.4);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 2;
      transition: all 0.2s ease;
    }
    
    .slider-nav-btn:hover {
      background: rgba(0,0,0,0.7);
    }
    
    .slider-nav-btn.prev {
      left: 10px;
    }
    
    .slider-nav-btn.next {
      right: 10px;
    }
    
    .image-indicators {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 5px;
      z-index: 2;
    }
    
    .image-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .image-indicator.active {
      background: white;
      transform: scale(1.2);
    }
    
    .image-count {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.5);
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      z-index: 2;
    }
    
    .gallery-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .gallery-btn:hover {
      background: #5a6268;
    }
    
    .details-gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    /* Gallery Modal */
    #galleryModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .gallery-modal-content {
      width: 90%;
      max-width: 1000px;
      height: 90%;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    .gallery-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 30px;
      cursor: pointer;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    
    .gallery-header {
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .gallery-header h3 {
      margin: 0;
      font-size: 1.5rem;
    }
    
    .gallery-counter {
      font-size: 0.9rem;
      color: #ccc;
    }
    
    .gallery-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    
    .gallery-main img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    
    .gallery-nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 5;
      font-size: 1.5rem;
    }
    
    .gallery-nav-btn.prev {
      left: 20px;
    }
    
    .gallery-nav-btn.next {
      right: 20px;
    }
    
    .gallery-thumbnails {
      display: flex;
      gap: 10px;
      padding: 15px;
      overflow-x: auto;
      scrollbar-width: thin;
      scrollbar-color: #666 #333;
      background: rgba(0,0,0,0.5);
    }
    
    .gallery-thumbnail {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s ease;
    }
    
    .gallery-thumbnail.active {
      opacity: 1;
      border: 2px solid white;
    }
    
    .gallery-thumbnail:hover {
      opacity: 0.9;
    }
    
    /* Individual image modal */
    #imageModal {
      z-index: 2001;
    }

    /* New Check Availability button */
    .check-availability-btn {
      width: 100%;
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .check-availability-btn:hover {
      background-color: #388E3C;
      transform: translateY(-2px);
    }

    .photos-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      background: transparent;
      border: none;
      color: #666;
      font-size: 0.9rem;
      padding: 5px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .photos-btn:hover {
      color: #333;
    }
    
    /* Contact fixed elements */
    .contact-fixed-left {
      position: fixed;
      left: 20px;
      bottom: 20px;
      z-index: 999;
    }
    
    .contact-fixed-left img {
      width: 50px;
      height: 50px;
      transition: transform 0.3s ease;
    }
    
    .contact-fixed-left img:hover {
      transform: scale(1.1);
    }
    
    .contact-fixed-right {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 999;
    }
    
    .phone-number {
      display: inline-block;
      background: #e67e22;
      color: white;
      padding: 10px 15px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    
    .phone-number:hover {
      background: #d35400;
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      color: white;
    }
   
    
    @media (max-width: 768px) {
      .footer-grid {
        grid-template-columns: 1fr;
        text-align: center;
      }
      
      .footer-links h4:after, 
      .footer-contact h4:after, 
      .footer-social h4:after {
        left: 50%;
        transform: translateX(-50%);
      }
      
      .footer-contact li {
        justify-content: center;
      }
      
      .social-icons {
        justify-content: center;
      }
    }
   
  </style>  
</head>
<body>
  
  <!-- Navbar -->
  <header class="navbar">
    <div class="logo">
      <img src="assets/images/logo.jpeg" alt="Logo">
    </div>

    <nav class="nav-links" id="navLinks">
       <a href="index.html">Home</a>
      <a href="listings.html">Property</a>
      <a href="contact.html">Contact</a>
        <a href="blog.html">Blog</a>
      <a href="aboutus.html">AboutUs</a>
    </nav>

    <div class="menu-toggle" id="menuToggle">
      <i class="fas fa-bars" id="openIcon"></i>
      <i class="fas fa-times" id="closeIcon" style="display: none;"></i>
    </div>
  </header>

  <!-- ======= Main Content ======= -->

  <!-- Buy a Home Button -->
<div class="find-sales">
  <h2>Sales Properties</h2>
</div>

<!-- Properties for Sale Section -->
<section id="sales-properties" class="properties">
  <div id="loadingState" class="loading">
    <i class="fas fa-spinner fa-spin"></i> Loading properties...
  </div>
  
  <div id="errorState" class="error" style="display: none;">
    <i class="fas fa-exclamation-triangle"></i> Failed to load properties. Please try again later.
  </div>
  
  <div id="propertiesContainer">
    <!-- Properties will be loaded here -->
  </div>
</section>

<!-- Viewing Modal -->
<div id="viewingModal">
  <div class="modal-content">
    <button class="close" onclick="closeViewingForm()">&times;</button>
    <h2>Schedule a Viewing</h2>
    <form id="viewingForm" onsubmit="submitViewing(event)">
      <input type="hidden" id="propertyId" name="propertyId">
      <input type="text" id="fullName" name="fullName" placeholder="Full Name" required>
      <input type="tel" id="contactInfo" name="contactInfo" placeholder="Contact Info (Phone/Email)" required>
      
      <div class="datetime-container">
        <input type="date" id="preferredDate" name="preferredDate" required>
        <input type="time" id="preferredTime" name="preferredTime" required>
      </div>
      
      <textarea id="comments" name="comments" placeholder="Any Comments (Optional)" rows="3"></textarea>
      <button type="submit" class="book-btn">
        <span id="submitText">Submit</span>
        <span id="submitLoading" style="display: none;">
          <i class="fas fa-spinner fa-spin"></i> Submitting...
        </span>
      </button>
    </form>
  </div>
</div>

<!-- Calendar Modal -->
<div id="calendarModal" class="calendar-modal">
  <div class="calendar-modal-content">
    <button class="calendar-modal-close" onclick="closeCalendarModal()">&times;</button>
    
    <div class="calendar-header">
      <h3>Viewing Availability</h3>
    </div>
    
    <div class="calendar-property-info">
      <img id="calendar-property-img" src="assets/images/final.png" alt="Property">
      <div class="calendar-property-details">
        <h4 id="calendar-property-title">Property Title</h4>
        <p id="calendar-property-location">Location</p>
      </div>
    </div>
    
    <div class="calendar-legend">
      <div class="legend-item">
        <div class="legend-color legend-available"></div>
        <span>Available</span>
      </div>
      <div class="legend-item">
        <div class="legend-color legend-booked"></div>
        <span>Booked</span>
      </div>
      <div class="legend-item">
        <div class="legend-color legend-past"></div>
        <span>Past Date</span>
      </div>
    </div>
    
    <div id="property-calendar"></div>
    
    <div class="calendar-actions">
      <button class="calendar-book-btn" onclick="openViewingFormFromCalendar()">Schedule Viewing</button>
    </div>
  </div>
</div>

<!-- Gallery Modal -->
<div id="galleryModal">
  <div class="gallery-modal-content">
    <button class="gallery-close" onclick="closeGalleryModal()">&times;</button>
    
    <div class="gallery-header">
      <h3 id="gallery-property-title">Property Gallery</h3>
      <div id="gallery-image-counter" class="gallery-counter">1 of 5</div>
    </div>
    
    <div class="gallery-main">
      <img id="galleryMainImage" src="" alt="Gallery Image">
      <button class="gallery-nav-btn prev" onclick="previousGalleryImage()">
        <i class="fas fa-chevron-left"></i>
      </button>
      <button class="gallery-nav-btn next" onclick="nextGalleryImage()">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
    
    <div id="galleryThumbnails" class="gallery-thumbnails">
      <!-- Thumbnails will be added here -->
    </div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal">
  <div style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center;">
    <button onclick="closeImageModal()" style="position: absolute; top: 20px; right: 30px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 30px; cursor: pointer; padding: 10px; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">&times;</button>
    <img id="modalImage" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;" src="" alt="">
    <div id="modalImageTitle" style="position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); color: white; text-align: center; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 5px;"></div>
  </div>
</div>

<!-- Viewing Success Modal -->
<div id="viewingSuccess">
  <div class="success-content">
    <div class="success-icon">
      <i class="fas fa-check"></i>
    </div>
    <h3 class="success-title">Booking Confirmed!</h3>
    <p class="success-message">Thank you for scheduling a viewing. We'll be in touch to confirm the time and guide you through the process!</p>
    <button class="success-button" onclick="closeSuccessModal()">Continue Browsing</button>
  </div>
</div>

<!-- WhatsApp icon on the left -->
<div class="contact-fixed-left">
  <a href="https://wa.me/+254 708129949" target="_blank" aria-label="Chat on WhatsApp">
    <img src="https://img.icons8.com/color/48/000000/whatsapp--v1.png" alt="WhatsApp">
  </a>
</div>

<!-- Phone number on the right -->
<div class="contact-fixed-right">
  <a href="tel:+254 708129949" class="phone-number">CALL:+254 708129949</a>
</div>
 <!-- Footer -->
 <footer class="new-footer">
  <div class="footer-grid">
      <div class="footer-brand">
          <h2>WeRent</h2>
          <p>Find the perfect property across Watamu with WeRent. Whether for rent or sale, we simplify your search experience.</p>
      </div>

      <div class="footer-links">
          <h4>Explore</h4>
          <ul>
              <li><a href="index.html">Home</a></li>
              <li><a href="listings.html">Properties</a></li>
              <li><a href="blog.html">Blog</a></li>
              <li><a href="aboutus.html">About Us</a></li>
              <li><a href="contact.html">Contact</a></li>
          </ul>
      </div>

      <div class="footer-contact">
          <h4>Contact Us</h4>
          <ul>
              <li>
                  <i class="fas fa-map-marker-alt"></i> 
                  <a href="https://maps.app.goo.gl/bq331K8qRBCPPxT47" target="_blank">
                      Jacaranda Road, Watamu
                  </a>
              </li>
              <li><i class="fas fa-phone"></i> <a href="tel:+254 708129949">+254 708129949</a></li>
              <li><i class="fas fa-envelope"></i> <a href="mailto:werent@werentonline.com">werent@werentonline.com</a></li>
          </ul>
      </div>

      <div class="footer-social">
          <h4>Follow Us</h4>
          <div class="social-icons">
              <a href="#" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
    
               <a href="https://www.instagram.com/we_rent_watamu?igsh=MTB4Y3Q3d2t4cnZnaw%3D%3D&utm_source=qr" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
   
          <a href="https://www.tiktok.com/@we_rent_watamu?_t=ZM-8wvIJjEDkSW&_r=1" target="_blank" aria-label="TikTok"><i class="fab fa-tiktok"></i></a>
        </div>
      </div>
  </div>

  <div class="footer-bottom">
      <p>&copy; 2025 WeRent. All rights reserved.</p>
  </div>
</footer>

<!-- Flatpickr Calendar JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Main JavaScript -->
<script>
// API Base URL
const API_BASE = 'https://estates-qmk8.onrender.com/api/v1';

// Global variables
let selectedPropertyId = null;
let allProperties = [];
let calendarInstance = null;
let propertyViewings = {};
let globalBookedDates = {}; // Store booked dates by property ID

// Variables for image gallery functionality
let currentGalleryImages = [];
let currentGalleryIndex = 0;
let propertyImageSliders = {};

// Fetch and display properties
async function fetchSalesProperties() {
  try {
    showLoading();
    const response = await fetch(`${API_BASE}/properties`);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    // Filter properties with listingType "Sale"
    const salesProperties = data.data.filter(property => property.listingType === 'Sale');
    allProperties = salesProperties;
    
    // Fetch booking/viewing data for all properties
    await fetchAllViewingData(salesProperties);
    
    displayProperties(salesProperties);
    
  } catch (error) {
    console.error('Error fetching properties:', error);
    showError();
  } finally {
    hideLoading();
  }
}

// Improved: Fetch viewing data for all properties and organize it by property
async function fetchAllViewingData(properties) {
  try {
    const viewingsResponse = await fetch(`${API_BASE}/viewings`);
    if (!viewingsResponse.ok) {
      console.error('Failed to fetch viewings data');
      return;
    }
    
    const viewingsData = await viewingsResponse.json();
    const viewings = viewingsData.data || [];
    
    // Clear previous viewings data
    propertyViewings = {};
    globalBookedDates = {};
    
    // Organize viewings by property ID
    properties.forEach(property => {
      const propertyId = property._id;
      const propertyViewingData = viewings.filter(v => v.propertyId === propertyId);
      propertyViewings[propertyId] = propertyViewingData;
      
      // Extract and store booked dates for this property
      const bookedDates = [];
      
      propertyViewingData.forEach(viewing => {
        if (viewing.preferredDate) {
          const viewingDate = new Date(viewing.preferredDate);
          // Format as YYYY-MM-DD
          const formattedDate = viewingDate.toISOString().split('T')[0];
          bookedDates.push(formattedDate);
        }
      });
      
      // Store booked dates for this property
      globalBookedDates[propertyId] = bookedDates;
    });
    
    console.log('Viewings data fetched and organized:', propertyViewings);
    console.log('Booked dates organized by property:', globalBookedDates);
    
  } catch (error) {
    console.error('Error fetching viewings:', error);
  }
}

// Refresh calendar data when new viewing is added
async function refreshViewingData() {
  try {
    await fetchAllViewingData(allProperties);
    console.log('Viewing data refreshed');
    
    // If calendar is open, refresh it
    if (calendarInstance && selectedPropertyId) {
      updateCalendarWithBookedDates(selectedPropertyId);
    }
  } catch (error) {
    console.error('Error refreshing viewing data:', error);
  }
}

// Update calendar with current booked dates
function updateCalendarWithBookedDates(propertyId) {
  if (!calendarInstance) return;
  
  // Get booked dates for this property
  const bookedDates = globalBookedDates[propertyId] || [];
  
  // Update calendar's disabled dates
  calendarInstance.set('disable', bookedDates);
  
  // Reapply custom styling
  setTimeout(() => {
    customizePastDates(calendarInstance);
    customizeBookedDates(calendarInstance, bookedDates);
  }, 100);
  
  console.log(`Calendar updated with booked dates for property ${propertyId}:`, bookedDates);
}

// Initialize image sliders for each property card
function initializeImageSlider(propertyId, images) {
  if (!images || images.length <= 1) return;
  
  propertyImageSliders[propertyId] = {
    images: images,
    currentIndex: 0
  };
  
  // Update indicators
  updateImageIndicators(propertyId);
}

// Navigate property card images
function navigatePropertyImage(propertyId, direction) {
  if (!propertyImageSliders[propertyId]) return;
  
  const slider = propertyImageSliders[propertyId];
  const totalImages = slider.images.length;
  
  if (direction === 'next') {
    slider.currentIndex = (slider.currentIndex + 1) % totalImages;
  } else {
    slider.currentIndex = (slider.currentIndex - 1 + totalImages) % totalImages;
  }
  
  // Update slider position
  const sliderElement = document.querySelector(`#property-${propertyId} .property-image-slider`);
  if (sliderElement) {
    sliderElement.style.transform = `translateX(-${slider.currentIndex * 100}%)`;
  }
  
  // Update indicators
  updateImageIndicators(propertyId);
}

// Update image indicators
function updateImageIndicators(propertyId) {
  const indicators = document.querySelectorAll(`#property-${propertyId} .image-indicator`);
  const currentIndex = propertyImageSliders[propertyId]?.currentIndex || 0;
  
  indicators.forEach((indicator, index) => {
    indicator.classList.toggle('active', index === currentIndex);
  });
  
  // Update image counter
  const counter = document.querySelector(`#property-${propertyId} .image-count`);
  if (counter && propertyImageSliders[propertyId]) {
    const total = propertyImageSliders[propertyId].images.length;
    counter.textContent = `${currentIndex + 1}/${total}`;
  }
}

// Go to specific image
function goToPropertyImage(propertyId, index) {
  if (!propertyImageSliders[propertyId]) return;
  
  propertyImageSliders[propertyId].currentIndex = index;
  
  const sliderElement = document.querySelector(`#property-${propertyId} .property-image-slider`);
  if (sliderElement) {
    sliderElement.style.transform = `translateX(-${index * 100}%)`;
  }
  
  updateImageIndicators(propertyId);
}

// Open gallery modal
function openGalleryModal(propertyId, startIndex = 0) {
  const property = allProperties.find(p => p._id === propertyId);
  if (!property) {
    alert('Property not found');
    return;
  }
  
  // Combine all images like in displayProperties
  let allImages = [];
  if (property.mainImage) allImages.push(property.mainImage);
  if (property.galleryImages && Array.isArray(property.galleryImages)) {
    property.galleryImages.forEach(img => {
      if (img && !allImages.includes(img)) allImages.push(img);
    });
  }
  
  if (allImages.length === 0) {
    alert('No images available for this property');
    return;
  }
  
  currentGalleryImages = allImages;
  currentGalleryIndex = startIndex;
  
  // Set property info
  document.getElementById('gallery-property-title').textContent = property.title || 'Property Gallery';
  
  // Display modal
  const modal = document.getElementById('galleryModal');
  modal.style.display = 'flex';
  
  // Load images
  loadGalleryImage();
  createGalleryThumbnails();
  
  // Prevent body scroll
  document.body.style.overflow = 'hidden';
}

// Load gallery image
function loadGalleryImage() {
  const mainImage = document.getElementById('galleryMainImage');
  const counter = document.getElementById('gallery-image-counter');
  
  if (currentGalleryImages.length > 0) {
    mainImage.src = currentGalleryImages[currentGalleryIndex];
    counter.textContent = `${currentGalleryIndex + 1} of ${currentGalleryImages.length}`;
  }
  
  // Update thumbnail selection
  updateGalleryThumbnails();
}

// Create gallery thumbnails
function createGalleryThumbnails() {
  const container = document.getElementById('galleryThumbnails');
  container.innerHTML = '';
  
  currentGalleryImages.forEach((image, index) => {
    const thumbnail = document.createElement('img');
    thumbnail.src = image;
    thumbnail.className = 'gallery-thumbnail';
    thumbnail.onclick = () => goToGalleryImage(index);
    thumbnail.onerror = () => thumbnail.style.display = 'none';
    container.appendChild(thumbnail);
  });
  
  updateGalleryThumbnails();
}

// Update gallery thumbnails
function updateGalleryThumbnails() {
  const thumbnails = document.querySelectorAll('.gallery-thumbnail');
  thumbnails.forEach((thumb, index) => {
    thumb.classList.toggle('active', index === currentGalleryIndex);
  });
}

// Navigate gallery images
function nextGalleryImage() {
  currentGalleryIndex = (currentGalleryIndex + 1) % currentGalleryImages.length;
  loadGalleryImage();
}

function previousGalleryImage() {
  currentGalleryIndex = (currentGalleryIndex - 1 + currentGalleryImages.length) % currentGalleryImages.length;
  loadGalleryImage();
}

function goToGalleryImage(index) {
  currentGalleryIndex = index;
  loadGalleryImage();
}

// Close gallery modal
function closeGalleryModal() {
  document.getElementById('galleryModal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

// Open image modal
function openImageModal(imageSrc, propertyTitle) {
  const modal = document.querySelector('#imageModal > div');
  const modalImage = document.getElementById('modalImage');
  const modalTitle = document.getElementById('modalImageTitle');
  
  modalImage.src = imageSrc;
  modalTitle.textContent = propertyTitle || 'Property Image';
  
  modal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

// Close image modal
function closeImageModal() {
  const modal = document.querySelector('#imageModal > div');
  if (modal) {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

// IMPROVED: Open calendar modal with enhanced calendar functionality to properly show booked dates
function openCalendarModal(propertyId) {
  selectedPropertyId = propertyId;
  
  // Find property data
  const property = allProperties.find(p => p._id === propertyId);
  if (!property) return;
  
  // Set property info in modal
  document.getElementById('calendar-property-title').textContent = property.title;
  document.getElementById('calendar-property-location').textContent = property.location;
  
  const imageUrl = property.mainImage || (property.galleryImages && property.galleryImages.length > 0 ? property.galleryImages[0] : 'assets/images/final.png');
  document.getElementById('calendar-property-img').src = imageUrl;
  
  // Get booked dates for this property from our global storage
  const bookedDates = globalBookedDates[propertyId] || [];
  
  console.log(`Opening calendar for property ${propertyId} with booked dates:`, bookedDates);
  
  // Get today's date and yesterday for comparison
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Initialize calendar
  if (calendarInstance) {
    calendarInstance.destroy();
  }
  
  calendarInstance = flatpickr("#property-calendar", {
    inline: true,
    mode: "single",
    minDate: "today",
    // Allow scheduling up to 18 months in advance
    maxDate: new Date().fp_incr(548), // ~18 months
    disable: bookedDates, // Disable booked dates
    dateFormat: "Y-m-d",
    defaultDate: "today",
    showMonths: window.innerWidth >= 768 ? 2 : 1, // Show 2 months on desktop, 1 on mobile
    onChange: function(selectedDates) {
      // Update viewing button based on selection
      const bookBtn = document.querySelector('.calendar-book-btn');
      if (selectedDates.length === 1) {
        bookBtn.removeAttribute('disabled');
        bookBtn.textContent = `Schedule Viewing for ${selectedDates[0].toLocaleDateString()}`;
      } else {
        bookBtn.setAttribute('disabled', 'disabled');
        bookBtn.textContent = 'Select a date';
      }
    },
    onReady: function(selectedDates, dateStr, instance) {
      // Add custom class to past dates
      customizePastDates(instance);
      
      // Customize booked dates
      customizeBookedDates(instance, bookedDates);
    },
    onMonthChange: function(selectedDates, dateStr, instance) {
      // Need to reapply custom styling after month changes
      setTimeout(() => {
        customizePastDates(instance);
        customizeBookedDates(instance, bookedDates);
      }, 100);
    }
  });
  
  // Show the modal
  document.getElementById('calendarModal').style.display = 'flex';
  
  // Make calendar responsive
  makeCalendarResponsive();
}

// Make calendar responsive based on screen size
function makeCalendarResponsive() {
  const updateCalendarMonths = () => {
    if (calendarInstance) {
      if (window.innerWidth >= 768) {
        calendarInstance.set('showMonths', 2); // Show 2 months on larger screens
      } else {
        calendarInstance.set('showMonths', 1); // Show 1 month on mobile
      }
      
      // Need to reapply custom styling after changing months count
      setTimeout(() => {
        if (selectedPropertyId) {
          const bookedDates = globalBookedDates[selectedPropertyId] || [];
          customizePastDates(calendarInstance);
          customizeBookedDates(calendarInstance, bookedDates);
        }
      }, 100);
    }
  };
  
  // Initial call
  updateCalendarMonths();
  
  // Listen for resize events
  window.addEventListener('resize', updateCalendarMonths);
}

// Customize past dates in the calendar
function customizePastDates(calendarInstance) {
  // Current date
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  // Get all calendar day elements
  const dayElements = calendarInstance.calendarContainer.querySelectorAll('.flatpickr-day');
  
  dayElements.forEach(dayElem => {
    // Check if this is a valid date (not a placeholder for another month)
    if (!dayElem.classList.contains('prevMonthDay') && !dayElem.classList.contains('nextMonthDay')) {
      const dateStr = dayElem.getAttribute('aria-label');
      if (dateStr) {
        const date = new Date(dateStr);
        
        // Add past-date class to dates before today
        if (date < today) {
          dayElem.classList.add('past-date');
        }
      }
    }
  });
}

// IMPROVED: Customize booked dates in the calendar with more distinctive styling
function customizeBookedDates(calendarInstance, bookedDates) {
  // Get all calendar day elements
  const dayElements = calendarInstance.calendarContainer.querySelectorAll('.flatpickr-day');
  
  dayElements.forEach(dayElem => {
    // Check if day is already disabled (could be a past date)
    if (dayElem.classList.contains('flatpickr-disabled')) {
      // Get the date from the element
      const dateStr = dayElem.getAttribute('aria-label');
      if (dateStr) {
        const date = new Date(dateStr);
        const formattedDate = date.toISOString().split('T')[0];
        
        // If this date is in our booked dates array, add the booked-date class
        if (bookedDates.includes(formattedDate)) {
          dayElem.classList.add('booked-date');
          
          // Add a visual indicator to show it's booked
          if (!dayElem.querySelector('.booking-indicator')) {
            const indicator = document.createElement('span');
            indicator.className = 'booking-indicator';
            indicator.style.position = 'absolute';
            indicator.style.bottom = '2px';
            indicator.style.left = '50%';
            indicator.style.transform = 'translateX(-50%)';
            indicator.style.fontSize = '8px';
            indicator.style.color = '#c62828';
            indicator.innerHTML = '<i class="fas fa-calendar-times"></i>';
            dayElem.appendChild(indicator);
            
            // Add title attribute to show it's booked
            dayElem.title = 'This date is already booked';
          }
        }
      }
    }
  });
  
  console.log('Customized booked dates in calendar');
}

// Close calendar modal
function closeCalendarModal() {
  document.getElementById('calendarModal').style.display = 'none';
  if (calendarInstance) {
    calendarInstance.destroy();
    calendarInstance = null;
  }
}

// Display properties in the UI
function displayProperties(properties) {
  const container = document.getElementById('propertiesContainer');
  
  if (properties.length === 0) {
    container.innerHTML = `
      <div class="error">
        <i class="fas fa-home"></i> No properties for sale found at the moment.
      </div>
    `;
    return;
  }
  
  container.innerHTML = properties.map(property => {
    // Better image handling - combine mainImage with galleryImages
    let allImages = [];
    
    // Add main image first if it exists
    if (property.mainImage) {
      allImages.push(property.mainImage);
    }
    
    // Add gallery images, avoiding duplicates
    if (property.galleryImages && Array.isArray(property.galleryImages)) {
      property.galleryImages.forEach(img => {
        if (img && !allImages.includes(img)) {
          allImages.push(img);
        }
      });
    }
    
    // If no images at all, use placeholder
    if (allImages.length === 0) {
      allImages = ['assets/images/final.png'];
    }
    
    const hasMultipleImages = allImages.length > 1;
    
    return `
      <div class="sales-card" id="property-${property._id}">
        ${property.status ? `<div class="property-status ${property.status}">${property.status}</div>` : ''}
        
        <div class="property-image-container">
          ${hasMultipleImages ? `
            <div class="property-image-slider">
              ${allImages.map(img => `
                <div class="property-image-slide">
                   <img src="${img}" alt="${property.title}" onerror="this.src='assets/images/final.png'">
                </div>
              `).join('')}
            </div>
            <button class="slider-nav-btn prev" onclick="navigatePropertyImage('${property._id}', 'prev')">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button class="slider-nav-btn next" onclick="navigatePropertyImage('${property._id}', 'next')">
              <i class="fas fa-chevron-right"></i>
            </button>
            <div class="image-indicators">
              ${allImages.map((_, index) => `
                <div class="image-indicator ${index === 0 ? 'active' : ''}" onclick="goToPropertyImage('${property._id}', ${index})"></div>
              `).join('')}
            </div>
            <div class="image-count">1/${allImages.length}</div>
          ` : `
            <img src="${allImages[0]}" alt="${property.title}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.src='assets/images/final.png'">
          `}
        </div>
        
        <div class="content">
          <h3>${property.title}</h3>
          <p><strong>Ksh ${property.price.toLocaleString()}</strong></p>
          
          <div class="property-details">
            <div class="detail-item">
              <i class="fas fa-bed"></i>
              <span>${property.bedrooms} beds</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-bath"></i>
              <span>${property.bathrooms} baths</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-map-marker-alt"></i>
              <span>${property.location}</span>
            </div>
          </div>
          
          <!-- Check Availability Button with calendar icon -->
          <button class="check-availability-btn" onclick="openCalendarModal('${property._id}')" ${property.status === 'sold' ? 'disabled' : ''}>
            <i class="far fa-calendar-alt"></i> Check Availability
          </button>

          <div class="buttons">
            <button class="book-btn" onclick="openViewingForm('${property._id}')" ${property.status === 'sold' ? 'disabled' : ''}>
              ${property.status === 'sold' ? 'Sold' : 'Book a Viewing'}
            </button>
            <button class="details-btn" onclick="toggleDetails('${property._id}')">
              <span id="toggle-text-${property._id}">View More</span>
            </button>
          </div>
          
          ${hasMultipleImages ? `
            <div style="text-align: right; margin-top: 5px;">
              <button class="photos-btn" onclick="openGalleryModal('${property._id}', 0)">
                <i class="fas fa-images"></i> View all ${allImages.length} photos
              </button>
            </div>
          ` : ''}
          
          <div id="details-${property._id}" class="property-expanded">
            <p><strong>Description:</strong> ${property.description}</p>
            <p><strong>Property Type:</strong> ${property.propertyType.join ? property.propertyType.join(', ') : property.propertyType}</p>
            
            ${property.amenities && property.amenities.length > 0 ? `
              <p><strong>Amenities:</strong></p>
              <div class="amenities-list">
                ${property.amenities.map(amenity => `<span class="amenity-tag">${amenity}</span>`).join('')}
              </div>
            ` : ''}
            
            ${allImages.length > 0 ? `
              <div class="details-gallery" style="margin: 20px 0;">
                <strong style="color: #333; display: block; margin-bottom: 10px;">Photo Gallery (${allImages.length} photos):</strong>
                <div class="details-gallery-grid">
                  ${allImages.map((img, index) => `
                    <div style="position: relative; overflow: hidden; border-radius: 8px; aspect-ratio: 4/3; background: #f0f0f0;">
                      <img src="${img}" alt="Property Image ${index + 1}" 
                           onerror="this.parentElement.style.display='none'" 
                           style="width: 100%; height: 100%; object-fit: cover; cursor: pointer; transition: transform 0.3s ease;"
                           onmouseover="this.style.transform='scale(1.05)'"
                           onmouseout="this.style.transform='scale(1)'"
                           onclick="openImageModal('${img}', '${property.title} - Image ${index + 1}')">
                      <div style="position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem;">
                        ${index + 1}/${allImages.length}
                      </div>
                    </div>
                  `).join('')}
                </div>
                ${allImages.length > 4 ? `
                  <button onclick="openGalleryModal('${property._id}', 0)" 
                          style="margin-top: 10px; background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                    <i class="fas fa-expand"></i> View Full Gallery
                  </button>
                ` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Initialize sliders for properties with multiple images
  properties.forEach(property => {
    let allImages = [];
    if (property.mainImage) allImages.push(property.mainImage);
    if (property.galleryImages && Array.isArray(property.galleryImages)) {
      property.galleryImages.forEach(img => {
        if (img && !allImages.includes(img)) allImages.push(img);
      });
    }
    
    if (allImages.length > 1) {
      initializeImageSlider(property._id, allImages);
    }
  });
}

// Toggle property details
function toggleDetails(propertyId) {
  const detailsDiv = document.getElementById(`details-${propertyId}`);
  const toggleText = document.getElementById(`toggle-text-${propertyId}`);
  
  if (detailsDiv.style.display === 'block') {
    detailsDiv.style.display = 'none';
    toggleText.textContent = 'View More';
  } else {
    detailsDiv.style.display = 'block';
    toggleText.textContent = 'View Less';
  }
}

// Open viewing form
function openViewingForm(propertyId) {
  selectedPropertyId = propertyId;
  document.getElementById('propertyId').value = propertyId;
  
  // Set minimum date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('preferredDate').min = today;
  
  // Check if the calendar has a selected date to use
  let selectedDate = null;
  if (calendarInstance && calendarInstance.selectedDates.length > 0) {
    selectedDate = calendarInstance.selectedDates[0].toISOString().split('T')[0];
  }
  
  // Set the selected date if we have one from the calendar
  if (selectedDate) {
    document.getElementById('preferredDate').value = selectedDate;
  }
  
  document.getElementById('viewingModal').style.display = 'block';
}

// Open viewing form from calendar
function openViewingFormFromCalendar() {
  if (!selectedPropertyId || !calendarInstance) return;
  
  // Get selected date from calendar
  const selectedDate = calendarInstance.selectedDates[0]?.toISOString().split('T')[0];
  
  // Close calendar modal
  closeCalendarModal();
  
  // Open viewing form with selected date
  openViewingForm(selectedPropertyId);
  
  // Set the date if one was selected
  if (selectedDate) {
    document.getElementById('preferredDate').value = selectedDate;
  }
}

// Close viewing form
function closeViewingForm() {
  document.getElementById('viewingModal').style.display = 'none';
  document.getElementById('viewingForm').reset();
  selectedPropertyId = null;
}

// IMPROVED: Submit viewing form with proper handling of calendar updates
async function submitViewing(e) {
  e.preventDefault();
  
  const submitBtn = document.querySelector('#viewingForm button[type="submit"]');
  const submitText = document.getElementById('submitText');
  const submitLoading = document.getElementById('submitLoading');
  
  // Show loading state
  submitBtn.disabled = true;
  submitText.style.display = 'none';
  submitLoading.style.display = 'inline';
  
  try {
    const formData = new FormData(e.target);
    const propertyId = formData.get('propertyId');
    const viewingData = {
      propertyId: propertyId,
      fullName: formData.get('fullName'),
      contactInfo: formData.get('contactInfo'),
      preferredDate: formData.get('preferredDate'),
      preferredTime: formData.get('preferredTime'),
      comments: formData.get('comments') || ''
    };
    
    console.log('Submitting viewing request:', viewingData);
    
    const response = await fetch(`${API_BASE}/viewings`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(viewingData)
    });
    
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.message || 'Failed to submit viewing request');
    }
    
    const result = await response.json();
    console.log('Viewing submitted successfully:', result);
    
    // Store the booked date
    const bookedDate = viewingData.preferredDate;
    
    // Update our local viewing data
    if (!propertyViewings[propertyId]) {
      propertyViewings[propertyId] = [];
    }
    propertyViewings[propertyId].push(result.data);
    
    // Update our booked dates for this property
    if (!globalBookedDates[propertyId]) {
      globalBookedDates[propertyId] = [];
    }
    globalBookedDates[propertyId].push(bookedDate);
    
    console.log(`Added booking for ${bookedDate} to property ${propertyId}`);
    
    // Refresh viewing data from server to ensure we have the latest
    await refreshViewingData();
    
    // Close modal and show success
    closeViewingForm();
    showSuccessMessage();
    
  } catch (error) {
    console.error('Error submitting viewing:', error);
    alert('Failed to submit viewing request. Please try again.');
  } finally {
    // Reset button state
    submitBtn.disabled = false;
    submitText.style.display = 'inline';
    submitLoading.style.display = 'none';
  }
}

// Show success message
function showSuccessMessage() {
  const successModal = document.getElementById('viewingSuccess');
  successModal.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

// Close success modal
function closeSuccessModal() {
  document.getElementById('viewingSuccess').style.display = 'none';
  document.body.style.overflow = 'auto';
}

// Show loading state
function showLoading() {
  document.getElementById('loadingState').style.display = 'block';
  document.getElementById('errorState').style.display = 'none';
  document.getElementById('propertiesContainer').innerHTML = '';
}

// Hide loading state
function hideLoading() {
  document.getElementById('loadingState').style.display = 'none';
}

// Show error state
function showError() {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('errorState').style.display = 'block';
  document.getElementById('propertiesContainer').innerHTML = '';
}

// Close modal when clicking outside
window.onclick = function(event) {
  const viewingModal = document.getElementById('viewingModal');
  const calendarModal = document.getElementById('calendarModal');
  const galleryModal = document.getElementById('galleryModal');
  const imageModal = document.querySelector('#imageModal > div');
  const successModal = document.getElementById('viewingSuccess');
  
  if (event.target === viewingModal) {
    closeViewingForm();
  }
  
  if (event.target === calendarModal) {
    closeCalendarModal();
  }
  
  if (event.target === galleryModal) {
    closeGalleryModal();
  }
  
  if (event.target === imageModal) {
    closeImageModal();
  }
  
  if (event.target === successModal) {
    closeSuccessModal();
  }
}

// Menu toggle functionality
const menuToggle = document.getElementById('menuToggle');
const navLinks = document.getElementById('navLinks');
const openIcon = document.getElementById('openIcon');
const closeIcon = document.getElementById('closeIcon');

menuToggle.addEventListener('click', () => {
  navLinks.classList.toggle('active');

  if (navLinks.classList.contains('active')) {
    openIcon.style.display = 'none';
    closeIcon.style.display = 'block';
  } else {
    openIcon.style.display = 'block';
    closeIcon.style.display = 'none';
  }
});

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
  fetchSalesProperties();
  
  // Add resize event listener for calendar responsiveness
  window.addEventListener('resize', function() {
    if (calendarInstance) {
      makeCalendarResponsive();
    }
  });
});
</script>

 <!-- Bootstrap 5.3 JS CDN (with Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-TNbMZjwnuN+uyVXX9A++a2hQwGItV9q8OQa2k3+u7jVr8J5eG9+lGqQvFa+hmpoK" crossorigin="anonymous"></script>

<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/6825d1eec210aa190d47da1e/1ir9ro3q0';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
</body>
</html>